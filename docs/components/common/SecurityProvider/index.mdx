import { SecurityProvider, useSecurity } from '@taro-uno/ui';
import SecurityProviderExample from './examples/index';

<Meta title="通用组件 / SecurityProvider 安全提供者" description="提供应用级别的安全保护功能" />

<Description>
  SecurityProvider 组件提供了应用级别的安全保护功能，包括输入验证、XSS防护、安全头部设置等，帮助开发者构建更安全的应用。
</Description>

<CodeExample title="基本用法">
  <SecurityProviderExample />
  <ExampleCode>
  ```tsx
  import React from 'react';
  import { SecurityProvider } from '@taro-uno/ui';
  
  export default function App() {
    return (
      <SecurityProvider>
        {/* 应用内容 */}
      </SecurityProvider>
    );
  }
  ```
  </ExampleCode>
</CodeExample>

## 功能介绍

SecurityProvider 组件提供了以下核心功能：

### 输入安全
- 输入净化（防止 XSS 攻击）
- 输入验证
- 支持多种输入类型（HTML、属性、JSON）

### 安全头部
- 自动添加安全相关的 HTTP 头部
- 支持 Content-Security-Policy (CSP)
- 支持 HTTP Strict Transport Security (HSTS)

### 错误处理
- 安全的错误报告机制
- 集成 OWASP 安全钩子
- 与 ErrorBoundary 集成

### 安全上下文
- 提供全局安全上下文
- 可通过 useSecurity Hook 使用安全功能

## API

### SecurityProviderProps

| 属性 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| children | ReactNode | - | 应用内容 |
| cspEnabled | boolean | true | 是否启用 Content-Security-Policy |
| hstsEnabled | boolean | true | 是否启用 HTTP Strict Transport Security |

### SecurityContextType

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| sanitizeInput | (value: string, type?: 'html' \| 'attribute' \| 'json') => string | 输入净化函数 |
| validateInput | (value: string, rules: any) => any | 输入验证函数 |
| addSecurityHeaders | (headers: Record<string, string>) => Record<string, string> | 添加安全头部函数 |
| reportError | (error: Error) => void | 错误报告函数 |

### useSecurity Hook

```tsx
const { sanitizeInput, validateInput, addSecurityHeaders, reportError } = useSecurity();
```

## 使用示例

### 基本用法

```tsx
import { SecurityProvider } from '@taro-uno/ui';

function App() {
  return (
    <SecurityProvider>
      {/* 应用内容 */}
    </SecurityProvider>
  );
}
```

### 使用安全上下文

```tsx
import { useSecurity } from '@taro-uno/ui';
import { View, Text, Input } from '@tarojs/components';
import React, { useState } from 'react';

function SecureInput() {
  const { sanitizeInput, validateInput } = useSecurity();
  const [input, setInput] = useState('');
  const [error, setError] = useState('');

  const handleInput = (e) => {
    const value = e.detail.value;
    const sanitized = sanitizeInput(value, 'html');
    setInput(sanitized);

    // 验证输入
    const validation = validateInput(value, {
      required: true,
      minLength: 3,
      maxLength: 20,
    });

    if (!validation.isValid) {
      setError(validation.message);
    } else {
      setError('');
    }
  };

  return (
    <View>
      <Input value={input} onInput={handleInput} placeholder="请输入内容" />
      {error && <Text style={{ color: 'red' }}>{error}</Text>}
    </View>
  );
}
```

### 配置安全选项

```tsx
import { SecurityProvider } from '@taro-uno/ui';

function App() {
  return (
    <SecurityProvider
      cspEnabled={true} // 启用 Content-Security-Policy
      hstsEnabled={false} // 禁用 HTTP Strict Transport Security
    >
      {/* 应用内容 */}
    </SecurityProvider>
  );
}
```

### 手动添加安全头部

```tsx
import { useSecurity } from '@taro-uno/ui';
import React from 'react';

function SecureApiCall() {
  const { addSecurityHeaders } = useSecurity();

  const fetchData = async () => {
    try {
      const headers = addSecurityHeaders({});
      const response = await fetch('https://api.example.com/data', { headers });
      const data = await response.json();
      console.log(data);
    } catch (error) {
      console.error('API 调用失败:', error);
    }
  };

  return (
    <View>
      <Button onClick={fetchData}>发起安全 API 调用</Button>
    </View>
  );
}
```

### 错误报告

```tsx
import { useSecurity } from '@taro-uno/ui';
import React from 'react';

function ErrorReportingExample() {
  const { reportError } = useSecurity();

  const handleError = () => {
    try {
      // 可能出错的代码
      throw new Error('测试错误');
    } catch (error) {
      reportError(error);
      console.log('错误已报告');
    }
  };

  return (
    <View>
      <Button onClick={handleError}>触发错误报告</Button>
    </View>
  );
}
```

## 使用提示

1. **全局使用**：在应用的根组件中使用 SecurityProvider，为整个应用提供安全保护。

2. **输入处理**：所有用户输入都应该经过 sanitizeInput 处理，防止 XSS 攻击。

3. **输入验证**：使用 validateInput 对用户输入进行验证，确保数据格式正确。

4. **安全头部**：在发送 API 请求时，使用 addSecurityHeaders 添加安全头部。

5. **错误处理**：使用 reportError 报告应用错误，便于监控和调试。

6. **CSP 配置**：根据应用需求配置 Content-Security-Policy，限制资源加载来源。

7. **HSTS 配置**：在生产环境中启用 HSTS，强制使用 HTTPS 连接。

## 浏览器兼容性

| 浏览器 | 版本 | 支持情况 |
| --- | --- | --- |
| Chrome | 80+ | ✅ |
| Firefox | 75+ | ✅ |
| Safari | 13+ | ✅ |
| Edge | 80+ | ✅ |
| 微信小程序 | 基础库 2.10+ | ✅ |
| 支付宝小程序 | 基础库 2.7+ | ✅ |

## 无障碍支持

- 支持屏幕阅读器
- 不影响内容的可访问性
- 安全功能对用户体验无负面影响