import { LazyComponent, createLazyComponent } from '@taro-uno/ui';
import LazyComponentExample from './examples/index';

<Meta title="通用组件 / LazyComponent 懒加载组件" description="用于组件级别的懒加载和代码分割，提升应用性能" />

<Description>
  LazyComponent 组件提供了组件级别的懒加载和代码分割功能，可以延迟加载非关键组件，减少初始加载时间，提升应用性能。
</Description>

<CodeExample title="基本用法">
  <LazyComponentExample />
  <ExampleCode>
  ```tsx
  import React from 'react';
  import { LazyComponent, createLazyComponent } from '@taro-uno/ui';
  
  // 创建懒加载组件
  const HeavyComponent = createLazyComponent(() => import('./HeavyComponent'));
  
  export default function LazyComponentExample() {
    return (
      <View>
        <Text>这是一个懒加载组件示例</Text>
        <LazyComponent component={HeavyComponent} />
      </View>
    );
  }
  ```
  </ExampleCode>
</CodeExample>

## 功能介绍

LazyComponent 组件提供了以下核心功能：

### 懒加载能力
- 支持组件级别的懒加载
- 支持代码分割，减少初始加载体积
- 提供多种加载策略（eager、lazy、prefetch）

### 加载状态管理
- 显示加载中状态
- 自定义加载界面

### 错误处理
- 捕获组件加载错误
- 提供重试机制
- 自定义错误界面

### 性能优化
- 组件缓存机制
- 预加载功能
- 加载超时控制

## API

### LazyComponentProps

| 属性 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| component | LazyExoticComponent<ComponentType<any>> \| (() => Promise<ComponentType<any>>) | - | 懒加载的组件 |
| props | Record<string, any> | {} | 组件属性 |
| fallback | ReactNode | - | 加载状态显示 |
| errorFallback | ReactNode | - | 错误状态显示 |
| preloadDelay | number | 0 | 预加载延迟（毫秒） |
| preload | boolean | false | 是否预加载 |
| timeout | number | - | 加载超时时间（毫秒） |

### LazyComponentOptions

| 属性 | 类型 | 默认值 | 说明 |
| --- | --- | --- | --- |
| strategy | 'eager' \| 'lazy' \| 'prefetch' | 'lazy' | 加载策略 |
| retryCount | number | 3 | 错误重试次数 |
| retryDelay | number | 1000 | 重试延迟（毫秒） |
| cache | boolean | true | 是否缓存组件 |

### 工具函数

#### createLazyComponent

创建懒加载组件。

```tsx
function createLazyComponent<T extends ComponentType<any>>(
  importFn: () => Promise<{ default: T }>,
  options: LazyComponentOptions = {}
): LazyExoticComponent<T>
```

#### createLazyRoute

创建路由级别的懒加载组件。

```tsx
function createLazyRoute<T extends ComponentType<any>>(
  importFn: () => Promise<{ default: T }>,
  options: LazyComponentOptions = {}
): LazyExoticComponent<T>
```

#### createLazyComponents

批量创建懒加载组件。

```tsx
function createLazyComponents(
  components: Record<string, () => Promise<{ default: ComponentType<any> }>>,
  options: LazyComponentOptions = {}
): Record<string, LazyExoticComponent<ComponentType<any>>>
```

#### clearComponentCache

清理组件缓存。

```tsx
function clearComponentCache(): void
```

## 使用示例

### 基本用法

```tsx
import { createLazyComponent, LazyComponent } from '@taro-uno/ui';

// 创建懒加载组件
const HeavyComponent = createLazyComponent(() => import('./HeavyComponent'));

// 使用懒加载组件
<LazyComponent component={HeavyComponent} />
```

### 自定义加载界面

```tsx
<LazyComponent
  component={HeavyComponent}
  fallback={
    <View className="loading">
      <Text>加载中...</Text>
    </View>
  }
/>
```

### 自定义错误界面

```tsx
<LazyComponent
  component={HeavyComponent}
  errorFallback={
    <View className="error">
      <Text>组件加载失败</Text>
      <Button onClick={() => window.location.reload()}>重试</Button>
    </View>
  }
/>
```

### 不同加载策略

```tsx
// 立即加载
const EagerComponent = createLazyComponent(() => import('./EagerComponent'), {
  strategy: 'eager'
});

// 懒加载（默认）
const LazyComponent = createLazyComponent(() => import('./LazyComponent'), {
  strategy: 'lazy'
});

// 预加载
const PrefetchComponent = createLazyComponent(() => import('./PrefetchComponent'), {
  strategy: 'prefetch'
});
```

### 组件缓存

```tsx
// 启用缓存（默认）
const CachedComponent = createLazyComponent(() => import('./CachedComponent'), {
  cache: true
});

// 禁用缓存
const NoCacheComponent = createLazyComponent(() => import('./NoCacheComponent'), {
  cache: false
});
```

### 错误重试

```tsx
const RetryComponent = createLazyComponent(() => import('./RetryComponent'), {
  retryCount: 5, // 重试5次
  retryDelay: 2000 // 每次重试间隔2秒
});
```

### 预加载设置

```tsx
<LazyComponent
  component={HeavyComponent}
  preload={true} // 启用预加载
  preloadDelay={1000} // 延迟1秒后预加载
/>
```

## 使用提示

1. **合理使用**：对体积较大的组件或非首屏组件使用懒加载，提升初始加载性能。

2. **加载策略选择**：
   - `eager`：立即加载，适用于关键组件
   - `lazy`：按需加载，适用于非关键组件
   - `prefetch`：后台预加载，适用于可能需要的组件

3. **错误处理**：提供友好的错误界面和重试机制，提升用户体验。

4. **性能监控**：监控组件加载时间和错误率，优化加载策略。

5. **缓存策略**：对于频繁使用的组件，启用缓存可以提高加载速度。

6. **预加载时机**：根据用户行为和页面结构，合理设置预加载时机，避免资源浪费。

## 浏览器兼容性

| 浏览器 | 版本 | 支持情况 |
| --- | --- | --- |
| Chrome | 80+ | ✅ |
| Firefox | 75+ | ✅ |
| Safari | 13+ | ✅ |
| Edge | 80+ | ✅ |
| 微信小程序 | 基础库 2.10+ | ✅ |
| 支付宝小程序 | 基础库 2.7+ | ✅ |

## 无障碍支持

- 支持屏幕阅读器
- 提供加载状态的可访问性信息
- 错误状态下提供清晰的提示信息