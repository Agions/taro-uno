name: æ–‡æ¡£è‡ªåŠ¨åŒ–æ„å»ºå’Œéƒ¨ç½²

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # æ„å»ºæ–‡æ¡£
  build-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: å®‰è£… pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: å®‰è£…ä¾èµ–
      run: pnpm install --frozen-lockfile
      
    - name: ç”Ÿæˆæ–‡æ¡£
      run: node scripts/generate-docs.js all
      
    - name: æ„å»ºæ–‡æ¡£ç½‘ç«™
      run: |
        cd docs
        pnpm install
        pnpm build
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: docs-dist
        path: docs/.vitepress/dist

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy-docs:
    needs: build-docs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: docs-dist
        path: docs-dist
        
    - name: è®¾ç½® Pages
      uses: actions/configure-pages@v3
      
    - name: ä¸Šä¼ åˆ° Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: docs-dist
        
    - name: éƒ¨ç½²åˆ° Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # éƒ¨ç½²åˆ° Netlify (å¯é€‰)
  deploy-netlify:
    needs: build-docs
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: docs-dist
        path: docs-dist
        
    - name: éƒ¨ç½²åˆ° Netlify
      uses: netlify/actions/cli@master
      with:
        args: deploy --dir=docs-dist --prod
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # ç”Ÿæˆ API æ–‡æ¡£ JSON
  generate-api-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        
    - name: å®‰è£… pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: å®‰è£…ä¾èµ–
      run: pnpm install --frozen-lockfile
      
    - name: ç”Ÿæˆ API æ–‡æ¡£
      run: node scripts/generate-docs.js api
      
    - name: è½¬æ¢ä¸º JSON
      run: |
        node -e "
          const fs = require('fs');
          const path = require('path');
          const docsDir = path.join(process.cwd(), 'docs', 'api');
          
          if (fs.existsSync(docsDir)) {
            const apiDocs = {};
            const packages = fs.readdirSync(docsDir);
            
            packages.forEach(pkg => {
              const pkgDir = path.join(docsDir, pkg);
              if (fs.statSync(pkgDir).isDirectory()) {
                const readmePath = path.join(pkgDir, 'README.md');
                if (fs.existsSync(readmePath)) {
                  const content = fs.readFileSync(readmePath, 'utf8');
                  apiDocs[pkg] = content;
                }
              }
            });
            
            fs.writeFileSync(
              path.join(process.cwd(), 'docs', 'public', 'api-docs.json'),
              JSON.stringify(apiDocs, null, 2)
            );
          }
        "
        
    - name: ä¸Šä¼  API æ–‡æ¡£
      uses: actions/upload-artifact@v3
      with:
        name: api-docs-json
        path: docs/public/api-docs.json

  # æ£€æŸ¥æ–‡æ¡£é“¾æ¥
  check-links:
    runs-on: ubuntu-latest
    needs: build-docs
    
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: docs-dist
        path: docs-dist
        
    - name: æ£€æŸ¥é“¾æ¥
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/linkcheck.json'
        base-branch: 'main'
        folder: 'docs-dist'

  # ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡
  docs-stats:
    runs-on: ubuntu-latest
    needs: build-docs
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡
      run: |
        node -e "
          const fs = require('fs');
          const path = require('path');
          
          const stats = {
            totalFiles: 0,
            totalComponents: 0,
            totalHooks: 0,
            totalExamples: 0,
            lastUpdated: new Date().toISOString(),
            components: {},
            hooks: {}
          };
          
          // ç»Ÿè®¡ç»„ä»¶
          const componentsDir = path.join(process.cwd(), 'docs', 'components');
          if (fs.existsSync(componentsDir)) {
            const categories = fs.readdirSync(componentsDir);
            categories.forEach(category => {
              const categoryDir = path.join(componentsDir, category);
              if (fs.statSync(categoryDir).isDirectory()) {
                const files = fs.readdirSync(categoryDir);
                const componentFiles = files.filter(f => f.endsWith('.md'));
                stats.components[category] = componentFiles.length;
                stats.totalComponents += componentFiles.length;
                stats.totalFiles += componentFiles.length;
              }
            });
          }
          
          // ç»Ÿè®¡ Hooks
          const hooksDir = path.join(process.cwd(), 'docs', 'hooks');
          if (fs.existsSync(hooksDir)) {
            const hookFiles = fs.readdirSync(hooksDir).filter(f => f.endsWith('.md'));
            stats.totalHooks = hookFiles.length;
            stats.totalFiles += hookFiles.length;
          }
          
          // ç»Ÿè®¡ç¤ºä¾‹
          const examplesDir = path.join(process.cwd(), 'docs', 'examples');
          if (fs.existsSync(examplesDir)) {
            const exampleFiles = fs.readdirSync(examplesDir).filter(f => f.endsWith('.md'));
            stats.totalExamples = exampleFiles.length;
            stats.totalFiles += exampleFiles.length;
          }
          
          fs.writeFileSync(
            path.join(process.cwd(), 'docs', 'public', 'docs-stats.json'),
            JSON.stringify(stats, null, 2)
          );
          
          console.log('ğŸ“Š æ–‡æ¡£ç»Ÿè®¡:', JSON.stringify(stats, null, 2));
        "
        
    - name: ä¸Šä¼ ç»Ÿè®¡ä¿¡æ¯
      uses: actions/upload-artifact@v3
      with:
        name: docs-stats
        path: docs/public/docs-stats.json

  # å‘é€é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [build-docs, deploy-docs]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'release')
    
    steps:
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: needs.deploy-docs.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: 'ğŸ“š æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²ï¼'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: needs.deploy-docs.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: 'âŒ æ–‡æ¡£éƒ¨ç½²å¤±è´¥ï¼'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}