name: Automated Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  prepare-release:
    name: å‡†å¤‡å‘å¸ƒ
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.changesets.outputs.hasChangesets }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ£€æŸ¥ Changesets
        id: changesets
        uses: changesets/action@v1
        with:
          publish: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.should-release == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
        run: |
          pnpm run type-check
          pnpm run lint
          pnpm run test:coverage
          pnpm run build

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-build
          path: |
            packages/*/dist
            docs/.vitepress/dist
          retention-days: 30

  publish-npm:
    name: å‘å¸ƒåˆ° NPM
    runs-on: ubuntu-latest
    needs: [prepare-release, build-and-test]
    if: needs.prepare-release.outputs.should-release == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: release-build
          path: packages/*/dist

      - name: å‘å¸ƒåˆ° NPM
        run: pnpm publish -r
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-and-test, publish-npm]
    if: needs.prepare-release.outputs.should-release == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: release-build
          path: release-artifacts

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        run: |
          # è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "# Taro-Uno v${{ needs.prepare-release.outputs.version }} å‘å¸ƒ" > changelog.md
          echo "## å˜æ›´å†…å®¹" >> changelog.md
          echo "è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†å˜æ›´ä¿¡æ¯ã€‚" >> changelog.md

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare-release.outputs.version }}
          name: Release v${{ needs.prepare-release.outputs.version }}
          body_path: changelog.md
          files: |
            release-artifacts/**/*.js
            release-artifacts/**/*.d.ts
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-docs:
    name: éƒ¨ç½²æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [prepare-release, build-and-test]
    if: needs.prepare-release.outputs.should-release == 'true'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºæ–‡æ¡£
        run: pnpm run docs:build

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/.vitepress/dist
          cname: taro-uno.dev

  notify-release:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare-release, build-and-test, publish-npm, create-release, deploy-docs]
    if: always()
    steps:
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: ${{ needs.publish-npm.result == 'success' && needs.create-release.result == 'success' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: 'ğŸ‰ ç‰ˆæœ¬ v${{ needs.prepare-release.outputs.version }} å‘å¸ƒæˆåŠŸï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: ${{ needs.publish-npm.result == 'failure' || needs.create-release.result == 'failure' }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: 'âŒ ç‰ˆæœ¬å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}